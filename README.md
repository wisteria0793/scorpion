# 民泊業務管理サイトの開発

## 目的
- 現在、webサイトやスマートチェックインシステムに掲載している情報が個別で管理されているため、施設情報等を一元管理
- 来年度2026年4月から宿泊税が導入されるため、予約情報と支払い状況を連携
- 売り上げ状況を可視化し、年度内の売り上げ状況、昨年度同時期との比較を容易にし、次の施策を行える手助けをする
- 予約可能かどうかを毎度Beds24にアクセスしていたため、こちらで管理することでログインの手間を減らし、また、モバイルデバイスからも操作できるようなUI/UXを作成する
- 宿泊者名簿の提出を確認し、チェックインシステムと連携し、未提出であれば提出するよう案内を行う


## 開発環境
- フロントエンド: React
- バックエンド: Django
- 通知機能: Slack API(チェックイン・アウトの即時通知、当日の予約管理、新規予約の通知、宿泊税の支払い通知など)
- サーバ: Xサーバ VPS(すでに利用しているため)

## 開発期間
- 現時点(2025.11.21) ~ 2026.03.31をめどに開発

## 主な機能
本アプリケーションは、民泊運営を効率化するための以下の主要な機能を備えています。

- **ダッシュボード & 分析**
  - **売上分析**: 年度ごとの月別売上、管理形態（自社・委託）ごとの内訳をグラフで可視化します。
  - **前年同月比**: 今年度と昨年度の売上を月ごとに比較し、成長率を把握できます。
  - **国籍比率分析**: 宿泊者の国籍を円グラフで表示し、インバウンド顧客の傾向を分析します。

- **予約・施設管理**
  - **月別予約一覧**: 指定した月の予約を一覧で確認できます。
  - **施設情報管理**: アプリケーション内から直接、施設情報の登録、編集、削除が可能です。
  - **施設画像の管理**: 施設ごとに画像をアップロードし、一覧で管理できます。

- **認証**
  - ユーザー登録およびログイン機能を備えています。

## 機能一覧 (2025-12-03時点)
- [x] ログイン・ユーザ登録
- [x] 年度売り上げ状況、月刊売り上げ状況の可視化
- [ ] Beds24等の外部サービスからの予約情報同期
- [x] 施設情報登録・更新・削除
- [ ] 予約ごとの宿泊税支払い状況の管理・確認
- [ ] 宿泊者名簿の提出状況の管理・確認 (GCPスプレッドシート連携)
- [ ] Stripeを利用した宿泊税のオンライン決済
<!-- - [ ] 施設ごとの予約不可日の設定 -->

## 多言語対応フォームのデータ入力方法

動的フォームの多言語対応フィールド（フォームテンプレート名、質問文、選択肢）は、JSON形式で言語ごとの翻訳を記述する必要があります。Django管理画面の該当フィールドには、以下のJSON形式で入力してください。

### 1. フォームテンプレート名 (`FormTemplate.name`)
`name`フィールドは、フォームテンプレートの表示名を多言語で保持します。
```json
{
  "ja": "ヴィラ桜用名簿",
  "en": "Guest Roster for Villa Sakura"
}
```

### 2. 質問文 (`FormField.label`)
`label`フィールドは、各質問のテキストを多言語で保持します。
```json
{
  "ja": "お名前",
  "en": "Full Name"
}
```

### 3. 選択肢 (`FormField.options`)
`options`フィールドは、ラジオボタンやチェックボックスの選択肢を多言語で保持します。各言語の選択肢は配列で記述します。
```json
{
  "ja": ["日本/Japan", "その他/Other"],
  "en": ["Japan", "Other"]
}
```

## ドキュメント
本プロジェクトに関する詳細な設計やガイドラインは、`docs`ディレクトリ内の以下のファイルで管理しています。

- [**データベース設計**](./docs/database_design.md) - テーブル定義、ER図
- [**APIエンドポイント**](./docs/api_endpoints.md) - APIの仕様
- [**アーキテクチャ (クラス図)**](./docs/architecture_class_diagram.md) - バックエンドのクラス構成
- [**予約ステートマシン図**](./docs/reservation_state_diagram.md) - 予約のライフサイクル
- [**シーケンス図**](./docs/sequence_diagrams.md) - 主要機能の処理フロー


## セットアップ手順

### フロントエンド (React)

1.  **Node.jsのバージョン設定**
    `frontend`ディレクトリに移動し、Node Version Manager (`nvm`) を使って、プロジェクトで指定されたNode.jsのバージョンに切り替えます。
    ```bash
    cd frontend
    nvm use
    ```
    `.nvmrc`ファイルが使われるべきバージョンを自動的に読み込みます。もし該当バージョンがインストールされていない場合、`nvm install`を実行するよう`nvm`が指示してくれます。

2.  **依存関係のインストール**
    `npm`を使って必要なパッケージをインストールします。
    ```bash
    npm install
    ```

3.  **開発サーバーの起動**
    ```bash
    npm run dev
    ```
    サーバーが起動したら、コンソールに表示される `http://localhost:xxxx` のアドレスにブラウザでアクセスしてください。

---

### バックエンド (Django)

macOSでの環境構築手順です。

1.  **Pythonのバージョン管理 (`pyenv`)**
    `pyenv`がインストールされていない場合は、Homebrewでインストールすることを推奨します。
    ```bash
    brew install pyenv
    ```
    シェルの設定ファイル（`.zshrc`など）に初期化スクリプトを追加してください。
    ```bash
    echo 'eval "$(pyenv init -)"' >> ~/.zshrc
    ```

2.  **Pythonのインストール**
    プロジェクトのルートディレクトリに移動し、`.python-version`ファイルに記載されたPythonをインストールします。
    ```bash
    # (プロジェクトのルートディレクトリで実行)
    pyenv install
    ```

3.  **仮想環境の作成と有効化**
    `backend`ディレクトリに移動し、`venv`という名前の仮想環境を作成して有効化（アクティベート）します。
    ```bash
    cd backend
    python -m venv venv
    source venv/bin/activate
    ```
    これ以降のコマンドは、仮想環境が有効化された状態（プロンプトの先頭に`(venv)`と表示された状態）で実行してください。

4.  **依存関係のインストール**
    `pip`を使ってDjangoをインストールします。
    ```bash
    pip install django
    ```

5.  **データベースの初期化**
    以下のコマンドでデータベースを作成します。（初回のみ）
    ```bash
    python manage.py migrate
    ```

6.  **開発サーバーの起動**
    以下のコマンドで開発サーバーを起動します。
    ```bash
    python manage.py runserver
    ```
    起動後、ブラウザで `http://localhost:8000` にアクセスすると、Djangoのデフォルトページが表示されます。 
    
## デプロイ（フロントエンド自動デプロイ）

以下は本リポジトリに追加した GitHub Actions を使ったフロントエンド自動デプロイの手順と注意点です。

- 概要: `main` ブランチへ push すると、`/frontend` をビルドして GitHub Pages にデプロイするワークフローが動作します。ワークフローは `.github/workflows/deploy-frontend.yml` に追加済みです。

- 手順（簡易）:
  1. `frontend` の依存をインストールしてローカルでビルド確認:
```bash
cd frontend
npm install
npm run build
```
  2. 変更をコミットして `main` に push すると、GitHub Actions がビルドとデプロイを自動で行います。
  3. GitHub リポジトリの `Settings > Pages`（または `Pages` タブ）で公開 URL を確認してください。

- 重要な注意点（Vite の base 設定）:
  - GitHub Pages の「プロジェクトページ」（`https://<owner>.github.io/<repo>/`）にデプロイする場合、ビルド時にアセット参照が正しくならないことがあります。そのため `vite.config.js` に `base: '/<repo>/'` を設定することを推奨します（例: `base: '/scorpion/'`）。
  - 代替として React Router を `HashRouter` に切り替える方法や、Netlify/Vercel にデプロイする方法もあります（後者はリポジトリ連携のみで簡単にデプロイ可能）。

- トラブルシューティング:
  - Actions の実行ログを `Actions` タブで確認してください。
  - ローカルで `npm run build` を実行して `frontend/dist` が生成されるか確認してください。

必要であれば、この README に `vite.config.js` の自動上書き（`base` の追加）や、Netlify/Vercel 用の手順も追記します。どちらを優先しますか？


