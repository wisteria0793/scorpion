# バックエンド運用マニュアル

このドキュメントでは、バックエンドシステムの構成と、予約データを管理するための主要なコマンドについて説明します。

## 1. アプリケーション構成

Djangoバックエンドは、責務に応じて複数のアプリケーションに分割されています。

- `guest_forms`: 宿泊者名簿のフォーム定義（`FormTemplate`, `FormField`）や、名簿の提出内容（`GuestSubmission`）など、ゲストが直接入力するフォームに関連するモデルやロジックを管理します。施設の詳細情報（`Property`）もここに含まれます。

- `reservations`: Beds24 APIとの連携や、予約情報（`Reservation`）の管理に特化したアプリケーションです。予約データの同期処理や、最終同期時刻の記録（`SyncStatus`）などを担当します。

## 2. 予約データの同期

日々の予約データ（未来の予約）は、Beds24 APIから取得してローカルのデータベースに同期する必要があります。この操作は、Webサイトの売上レポート機能や、その他の予約情報に依存する機能が正しく動作するために不可欠です。

### `sync_bookings` コマンド

このコマンドは、未来の予約情報をBeds24から取得し、データベースを最新の状態に保ちます。

**機能:**
- 実行した日から365日後までの有効な予約（"Confirmed", "New"）をBeds24から全件取得します。
- 取得した情報をもとに、新規予約の作成や、既存予約の料金・ステータス変更などをデータベースに反映します。
- データベース上には存在するが、APIからのデータには含まれなくなった未来の予約を「キャンセルされた」と判断し、ステータスを`Cancelled`に更新します。
- 同期が完了した時刻を記録し、フロントエンドの「最終更新日時」として表示できるようにします。

**実行方法:**

```bash
# backendディレクトリで仮想環境を有効化して実行
cd backend
source venv/bin/activate
python manage.py sync_bookings
```

**推奨される運用:**
このコマンドは、少なくとも1日に1回、自動的に実行することを推奨します。`cron`ジョブなどを使って定期実行を設定してください。

## 3. 過去の予約データのインポート

過去の売上データをレポートに表示するためには、過去の予約データをデータベースにインポートする必要があります。この操作は通常、システムの初期セットアップ時や、特定の期間のデータを遡って分析したい場合に一度だけ実行します。

### `import_past_bookings` コマンド

このコマンドは、指定した期間の過去の予約データをBeds24から取得し、データベースに保存します。

**機能:**
- `--start-date`と`--end-date`で指定された期間の予約データをBeds24から取得します。
- 取得した予約情報（キャンセルされた予約は除く）をデータベースに作成・更新します。

**実行方法:**

`--start-date`と`--end-date`オプションで、取得したい期間を`YYYY-MM-DD`形式で指定します。

```bash
# 例: 2023年度（2023-03-01から2024-02-29まで）のデータをインポートする場合
cd backend
source venv/bin/activate
python manage.py import_past_bookings --start-date 2023-03-01 --end-date 2024-02-29
```

**注意点:**
- このコマンドは、すでに存在する予約データを上書き（更新）する可能性があります。
- 非常に長期間を指定すると、APIからのデータ取得に時間がかかる場合があります。

## 4. 認証 API (追加)

このプロジェクトでは、フロントエンドからのログイン/登録を簡易に実装するために、以下のエンドポイントを提供しています（開発用実装）。

- POST /api/auth/register/ — ユーザ登録
	- ボディ: { username, email?, password, password2 }
	- レスポンス: 作成したユーザの基本情報 (id, username, email)

- POST /api/auth/login/ — ログイン（セッションベース）
	- ボディ: { username, password }
	- レスポンス: ログインしたユーザの基本情報 (id, username, email)
	- 成功時にサーバがセッションクッキーをセットします。フロントエンドからは withCredentials を付けてリクエストしてください。

- POST /api/auth/logout/ — ログアウト
	- レスポンス: 204 No Content

- GET /api/auth/me/ — 現在のログインユーザ情報
	- レスポンス: ログイン中のユーザ情報 (id, username, email)

注意: 現在の実装では `register` と `login` エンドポイントを CSRF exempt にしており、ブラウザからクロスオリジン XHR で呼び出しやすいようにしています。これは開発利便性のためであり、本番運用では CSRF 対策（CSRF トークンのやり取りやトークンベース認証の導入）を検討してください。

テスト:

```bash
# backend ディレクトリで仮想環境を有効にして、依存を準備した後にテストを実行してください
cd backend
source venv/bin/activate
pip install -r requirements.txt  # (必要なら)
python manage.py test accounts
```

※ この開発環境のコンテナでは Django がインストールされていないため、CI やローカルで上記テストを実行して動作確認してください。
